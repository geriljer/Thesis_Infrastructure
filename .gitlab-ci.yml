deploy-helm:
  stage: deploy
  image: alpine/helm:3.9.4
  before_script:
    # Установка репозитория Helm из Nexus
    - helm repo add my-repo ${HELM_REPO} --username ${NEXUS_USER} --password ${NEXUS_PASS}
    - helm repo update
    - apk update && apk add --no-cache curl
    - curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
    - install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
    - mkdir -p ~/.kube
    - echo "$KUBECONFIG_BASE64" | base64 -d >> ~/.kube/config
    - kubectl config use-context momo-store-context
    # Убедитесь, что Helm может взаимодействовать с кластером
    - helm repo update
  script:
    # Обновление или установка чарта с использованием Helm и передача переменной $VERSION
    - helm upgrade --install momo-store-chart my-repo/momo-store --atomic --namespace default
  after_script:
    - rm ~/.kube/config
  environment:
    name: production
    url: http://momo-store.practicum.services.ru:80
  rules:
    - when: manual
